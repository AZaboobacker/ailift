name: Deploy to AWS App Runner

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Find new folder
      id: newfolder
      run: |
        git fetch --depth=2
        NEW_FOLDER=$(git diff --name-only HEAD^ HEAD | grep -oE '^[^/]+/' | sort -u | head -n 1)
        echo "NEW_FOLDER=${NEW_FOLDER}" >> $GITHUB_ENV
      shell: bash

    - name: Debug new folder
      run: echo "New folder is:${{ env.NEW_FOLDER }}"
      shell: bash

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v1

    - name: Log in to Amazon ECR
      uses: aws-actions/amazon-ecr-login@v1
      with:
        registry: ${{ secrets.ECR_REGISTRY }}
        region: ${{ secrets.AWS_REGION }}
        access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

    - name: Build, tag, and push Docker image
      run: |
        cd ${{ env.NEW_FOLDER }}
        docker build -t ${NEW_FOLDER%/}:latest .
        docker tag ${NEW_FOLDER%/}:latest ${{ secrets.ECR_REGISTRY }}/${NEW_FOLDER%/}:latest
        docker push ${{ secrets.ECR_REGISTRY }}/${NEW_FOLDER%/}:latest

    - name: Deploy to AWS App Runner
      run: |
        SERVICE_NAME=${NEW_FOLDER%/}-service
        aws apprunner create-service --service-name $SERVICE_NAME --source-configuration "{
          \"ImageRepository\": {
            \"ImageIdentifier\": \"${{ secrets.ECR_REGISTRY }}/${NEW_FOLDER%/}:latest\",
            \"ImageConfiguration\": {
              \"Port\": \"8501\"
            }
          },
          \"AuthenticationConfiguration\": {
            \"AccessRoleArn\": \"${{ secrets.APP_RUNNER_ROLE_ARN }}\"
          }
        }"
      env:
        AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        AWS_REGION: ${{ secrets.AWS_REGION }}
